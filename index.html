<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Data Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #3a506b;
        }
        .fund-container {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #eaeaea;
        }
        .loading {
            color: #777;
            font-style: italic;
        }
        .error {
            color: #c94040;
            font-weight: bold;
        }
        .status-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Mutual Fund Data Explorer</h1>
    <div class="status-container">
        <div id="overall-status">Loading fund data...</div>
    </div>

    <!-- Fund containers -->
    <div id="funds-container">
        <!-- These will be populated dynamically -->
    </div>

    <!-- Include the JavaScript modules -->
    <script src="fund-data-fetcher.js"></script>
    <script src="process-distributions.js"></script>
    
    <script>
        // Configuration
        const START_DATE = '2024-12-31';
        const FUND_TICKERS = ['ANCFX', 'AGTHX', 'AFAXX'];
        
        // Track completion status for each fund and data type
        const completionStatus = {
            total: FUND_TICKERS.length * 2, // 2 operations per fund (NAV and distributions)
            completed: 0,
            errors: []
        };
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadAllFundData();
        });
        
        // Set up the page with containers for each fund
        function initializePage() {
            const container = document.getElementById('funds-container');
            container.innerHTML = '';
            
            FUND_TICKERS.forEach(ticker => {
                const fundDiv = document.createElement('div');
                fundDiv.className = 'fund-container';
                fundDiv.innerHTML = `
                    <h2>${ticker} Fund Data</h2>
                    <div class="data-grid">
                        <div class="nav-data">
                            <h3>Net Asset Value (NAV) Data</h3>
                            <div id="${ticker}-nav-status" class="loading">Loading NAV data...</div>
                            <div id="${ticker}-nav-container"></div>
                        </div>
                        <div class="distribution-data">
                            <h3>Distribution Data</h3>
                            <div id="${ticker}-dist-status" class="loading">Loading distribution data...</div>
                            <div id="${ticker}-dist-container"></div>
                        </div>
                    </div>
                `;
                container.appendChild(fundDiv);
            });
        }
        
        // Load data for all funds
        function loadAllFundData() {
            FUND_TICKERS.forEach(ticker => {
                fetchNavData(ticker);
                fetchDistributionData(ticker);
            });
        }
        
        // Fetch NAV data for a specific fund
        function fetchNavData(ticker) {
            const statusElement = document.getElementById(`${ticker}-nav-status`);
            const containerElement = document.getElementById(`${ticker}-nav-container`);
            
            statusElement.textContent = `Fetching NAV data for ${ticker}...`;
            
            // Use the fetchFundData function from the imported module
            fetchFundData(ticker, START_DATE)
                .then(data => {
                    updateCompletionStatus(true);
                    
                    if (data && data.length > 0) {
                        statusElement.textContent = `Loaded ${data.length} NAV data points for ${ticker}`;
                        displayNavData(containerElement, data);
                    } else {
                        statusElement.textContent = `No NAV data available for ${ticker}`;
                    }
                })
                .catch(error => {
                    updateCompletionStatus(false, `NAV data error for ${ticker}: ${error.message}`);
                    statusElement.className = 'error';
                    statusElement.textContent = `Error fetching NAV data: ${error.message}`;
                });
        }
        
        // Fetch distribution data for a specific fund
        function fetchDistributionData(ticker) {
            const statusElement = document.getElementById(`${ticker}-dist-status`);
            const containerElement = document.getElementById(`${ticker}-dist-container`);
            
            statusElement.textContent = `Fetching distribution data for ${ticker}...`;
            
            // Use the getDistributionData function from the imported module
            getDistributionData(ticker, START_DATE)
                .then(result => {
                    updateCompletionStatus(true);
                    
                    if (result.error) {
                        statusElement.className = 'error';
                        statusElement.textContent = `Error: ${result.error}`;
                    } else if (result.items && result.items.length > 0) {
                        statusElement.textContent = `Loaded ${result.items.length} distribution data points for ${ticker}`;
                        displayDistributionData(containerElement, result.items);
                    } else {
                        statusElement.textContent = `No distribution data available for ${ticker}`;
                    }
                })
                .catch(error => {
                    updateCompletionStatus(false, `Distribution data error for ${ticker}: ${error.message}`);
                    statusElement.className = 'error';
                    statusElement.textContent = `Error fetching distribution data: ${error.message}`;
                });
        }
        
        // Update overall completion status
        function updateCompletionStatus(success, errorMessage = null) {
            completionStatus.completed++;
            
            if (!success && errorMessage) {
                completionStatus.errors.push(errorMessage);
            }
            
            const statusElement = document.getElementById('overall-status');
            const progress = Math.floor((completionStatus.completed / completionStatus.total) * 100);
            
            if (completionStatus.completed === completionStatus.total) {
                if (completionStatus.errors.length === 0) {
                    statusElement.textContent = `Data loading complete! All ${FUND_TICKERS.length} funds loaded successfully.`;
                    statusElement.style.color = '#4CAF50';
                } else {
                    statusElement.textContent = `Data loading complete with ${completionStatus.errors.length} errors.`;
                    statusElement.style.color = 'orange';
                }
            } else {
                statusElement.textContent = `Loading fund data: ${progress}% complete (${completionStatus.completed}/${completionStatus.total})`;
            }
        }
        
        // Display NAV data in a table
        function displayNavData(container, data) {
            // Limit to 10 most recent entries for display
            const recentData = data.slice(-10).reverse();
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>NAV</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentData.map(item => `
                        <tr>
                            <td>${item.date}</td>
                            <td>$${item.nav ? item.nav.toFixed(2) : 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        // Display distribution data in a table
        function displayDistributionData(container, data) {
            // Limit to 10 most recent entries for display
            const recentData = data.slice(-10).reverse();
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>NAV</th>
                        <th>Distribution</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentData.map(item => `
                        <tr>
                            <td>${item.date}</td>
                            <td>$${item.nav.toFixed(2)}</td>
                            <td>$${item.dist.toFixed(4)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }
    </script>
</body>
</html>
